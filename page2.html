<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã¡ã„ã‹ã‚ã‚®ãƒ£ãƒ©ãƒªãƒ¼</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: linear-gradient(#cce7ff, #ffffff);
      min-height: 100vh;
    }

    #back-btn {
      display: inline-block;
      margin-bottom: 20px;
      padding: 8px 14px;
      background: #eee;
      border: 1px solid #aaa;
      cursor: pointer;
    }

    #form-area {
      display: none;
      margin-bottom: 20px;
    }

    .card {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 20px;
      width: 250px;
      background: white;
      border-radius: 8px;
    }

    .card img {
      width: 100%;
      border-radius: 6px;
    }

    .like-btn {
      background: #ffdddd;
      border: 1px solid #ffaaaa;
      padding: 5px 10px;
      cursor: pointer;
      margin-right: 10px;
    }

    .delete-btn {
      background: #ddd;
      border: 1px solid #aaa;
      padding: 5px 10px;
      cursor: pointer;
    }

    #gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
  </style>
</head>

<body>

  <button id="back-btn" onclick="location.href='index.html'">â† ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</button>

  <h1>ã¡ã„ã‹ã‚ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h1>

  <button onclick="toggleForm()">æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã</button>

  <div id="form-area">
    <p>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼š</p>
    <input type="file" id="imageFile" />

    <p>èª¬æ˜ï¼š</p>
    <input type="text" id="desc" />

    <br><br>
    <button onclick="uploadItem()">æŠ•ç¨¿ã™ã‚‹</button>
  </div>

  <div id="gallery"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase åˆæœŸåŒ–
    const client = supabase.createClient(
      "https://ygwqpkeopbhztcgzkqke.supabase.co",
      "sb_publishable_yXUDCLKJxQKuMvt1LnDMSg_s8mLrrux"
    );

    // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ localStorage ã«ä¿å­˜ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãªã—ã§ä¸€äººä¸€å›ã‚’å®Ÿç¾ï¼‰
    let userId = localStorage.getItem("user_id");
    if (!userId) {
      userId = crypto.randomUUID();
      localStorage.setItem("user_id", userId);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleForm() {
      const area = document.getElementById("form-area");
      area.style.display = area.style.display === "none" ? "block" : "none";
    }

    // æŠ•ç¨¿å‡¦ç†
    async function uploadItem() {
      const file = document.getElementById("imageFile").files[0];
      const desc = document.getElementById("desc").value;

      if (!file) {
        alert("ç”»åƒã‚’é¸ã‚“ã§ã­");
        return;
      }

      const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
      const fileName = `${Date.now()}-${safeName}`;

      const { error: imgErr } = await client.storage
        .from("chiikawa-images")
        .upload(fileName, file);

      if (imgErr) {
        console.log("UPLOAD ERROR:", imgErr);
        alert("ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
        return;
      }

      const { data: publicUrl } = client.storage
        .from("chiikawa-images")
        .getPublicUrl(fileName);

      const { error: dbErr } = await client
        .from("items")
        .insert([{ image_url: publicUrl.publicUrl, description: desc }]);

      if (dbErr) {
        console.log("DB INSERT ERROR:", dbErr);
        alert("ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
        return;
      }

      alert("æŠ•ç¨¿å®Œäº†ï¼");
      loadItems();
    }

    // ã‚®ãƒ£ãƒ©ãƒªãƒ¼èª­ã¿è¾¼ã¿
    async function loadItems() {
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";

      const { data: items, error: itemsErr } = await client
        .from("items")
        .select("*")
        .order("created_at", { ascending: false });

      if (itemsErr) {
        console.log("items èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", itemsErr);
        return;
      }
      if (!items) {
        // ãƒ‡ãƒ¼ã‚¿ãŒ null ã®å ´åˆã¯ä½•ã‚‚æç”»ã—ãªã„
        return;
      }

      for (const item of items) {
        // likes ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã€Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã® item ã‚’ã„ã„ã­ã—ã¦ã„ã‚‹ã‹ã€ã‚’ç¢ºèª
        const { data: liked, error: likeErr } = await client
          .from("likes")
          .select("*")
          .eq("item_id", item.id)
          .eq("user_id", userId);

        // liked ãŒ null ã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã«ã‚¬ãƒ¼ãƒ‰
        const isLiked = !likeErr && Array.isArray(liked) && liked.length > 0;

        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
          <img src="${item.image_url}" />
          <p>${item.description || ""}</p>

          <button class="like-btn" onclick="toggleLike(${item.id})">
            ${isLiked ? "ğŸ’–" : "ğŸ¤"} ${item.likes ?? 0}
          </button>

          <button class="delete-btn" onclick="deleteItem(${item.id})">
            å‰Šé™¤
          </button>
        `;

        gallery.appendChild(div);
      }
    }

    // ã„ã„ã­ã®è¿½åŠ ï¼å–ã‚Šæ¶ˆã—
    async function toggleLike(itemId) {
      // ã™ã§ã«æŠ¼ã—ã¦ã„ã‚‹ã‹ç¢ºèª
      const { data: liked, error: likeErr } = await client
        .from("likes")
        .select("*")
        .eq("item_id", itemId)
        .eq("user_id", userId);

      if (!likeErr && Array.isArray(liked) && liked.length > 0) {
        // æŠ¼ã—ã¦ã„ãŸ â†’ å–ã‚Šæ¶ˆã—
        await client
          .from("likes")
          .delete()
          .eq("item_id", itemId)
          .eq("user_id", userId);
      } else {
        // æŠ¼ã—ã¦ã„ãªã„ or ã‚¨ãƒ©ãƒ¼ â†’ è¿½åŠ ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ã¨ã‚Šã‚ãˆãšè¿½åŠ å´ã«å€’ã™ï¼‰
        await client
          .from("likes")
          .insert([{ item_id: itemId, user_id: userId }]);
      }

      // æœ€æ–°ã®ã„ã„ã­æ•°ã‚’å–å¾—
      const { count, error: countErr } = await client
        .from("likes")
        .select("*", { count: "exact", head: true })
        .eq("item_id", itemId);

      if (!countErr) {
        // items.likes ã‚’æ›´æ–°ï¼ˆcount ãŒ undefined ã®ã¨ãã¯ 0 ã«ï¼‰
        await client
          .from("items")
          .update({ likes: count ?? 0 })
          .eq("id", itemId);
      }

      loadItems();
    }

    // å‰Šé™¤å‡¦ç†
    // æ”¹è‰¯ç‰ˆ toggleLikeï¼ˆãã®ã¾ã¾ç½®ãæ›ãˆã¦ä½¿ã£ã¦ï¼‰
async function toggleLike(itemId) {
  try {
    console.log("toggleLike start", { itemId, userId });

    // 1) æ—¢å­˜ã„ã„ã­ç¢ºèª
    const check = await client
      .from("likes")
      .select("*")
      .eq("item_id", itemId)
      .eq("user_id", userId);

    console.log("check result", check);

    if (check.error) {
      console.error("likes select error", check.error);
      alert("ã„ã„ã­ã®ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Consoleã‚’ç¢ºèªã—ã¦ã­ã€‚");
      return;
    }

    const liked = Array.isArray(check.data) && check.data.length > 0;

    if (liked) {
      // 2) å–ã‚Šæ¶ˆã—
      const del = await client
        .from("likes")
        .delete()
        .eq("item_id", itemId)
        .eq("user_id", userId);

      console.log("delete result", del);
      if (del.error) {
        console.error("likes delete error", del.error);
        alert("ã„ã„ã­ã®å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Consoleã‚’ç¢ºèªã—ã¦ã­ã€‚");
        return;
      }
    } else {
      // 3) è¿½åŠ 
      const ins = await client
        .from("likes")
        .insert([{ item_id: itemId, user_id: userId }]);

      console.log("insert result", ins);
      if (ins.error) {
        console.error("likes insert error", ins.error);
        alert("ã„ã„ã­ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Consoleã‚’ç¢ºèªã—ã¦ã­ã€‚");
        return;
      }
    }

    // 4) ã‚«ã‚¦ãƒ³ãƒˆå–å¾—
    const cnt = await client
      .from("likes")
      .select("*", { count: "exact", head: true })
      .eq("item_id", itemId);

    console.log("count result", cnt);
    if (cnt.error) {
      console.error("count error", cnt.error);
    } else {
      const newCount = cnt.count ?? 0;
      const upd = await client
        .from("items")
        .update({ likes: newCount })
        .eq("id", itemId);

      console.log("items update result", upd);
      if (upd.error) {
        console.error("items update error", upd.error);
      }
    }

    // 5) å†æç”»
    await loadItems();
  } catch (e) {
    console.error("toggleLike unexpected error", e);
    alert("äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Consoleã‚’ç¢ºèªã—ã¦ã­ã€‚");
  }
}


    // åˆå›èª­ã¿è¾¼ã¿
    loadItems();
  </script>

</body>
</html>
