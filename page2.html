<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Supabase 初期化
const client = supabase.createClient(
  "https://ygwqpkeopbhztcgzkqke.supabase.co",
  "sb_publishable_yXUDCLKJxQKuMvt1LnDMSg_s8mLrrux"
);

// フォーム表示切り替え
function toggleForm() {
  const area = document.getElementById("form-area");
  area.style.display = area.style.display === "none" ? "block" : "none";
}

// 投稿処理
async function uploadItem() {
  const file = document.getElementById("imageFile").files[0];
  const desc = document.getElementById("desc").value;

  if (!file) {
    alert("画像を選んでね");
    return;
  }

  // 日本語ファイル名を安全な名前に変換
  const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
  const fileName = `${Date.now()}-${safeName}`;

  // 画像アップロード
  const { data: imgData, error: imgErr } = await client.storage
    .from("chiikawa-images")
    .upload(fileName, file);

  if (imgErr) {
    console.log("UPLOAD ERROR:", imgErr);
    alert("画像アップロードに失敗しました");
    return;
  }

  // 公開URL取得
  const { data: publicUrl } = client.storage
    .from("chiikawa-images")
    .getPublicUrl(fileName);

  // DBに保存（likes は 0 で自動）
  const { error: dbErr } = await client
    .from("items")
    .insert([{ image_url: publicUrl.publicUrl, description: desc }]);

  if (dbErr) {
    alert("データ保存に失敗しました");
    return;
  }

  alert("投稿完了！");
  loadItems();
}

// ギャラリー読み込み
async function loadItems() {
  const gallery = document.getElementById("gallery");
  gallery.innerHTML = "";

  const { data: items } = await client
    .from("items")
    .select("*")
    .order("created_at", { ascending: false });

  items.forEach(item => {
    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <img src="${item.image_url}" />
      <p>${item.description || ""}</p>

      <button class="like-btn" onclick="likeItem(${item.id}, ${item.likes})">
        ❤️ ${item.likes}
      </button>

      <button class="delete-btn" onclick="deleteItem(${item.id})">
        削除
      </button>
    `;

    gallery.appendChild(div);
  });
}

// いいね処理
async function likeItem(id, currentLikes) {
  const { error } = await client
    .from("items")
    .update({ likes: currentLikes + 1 })
    .eq("id", id);

  if (error) {
    alert("いいねできなかった…");
    return;
  }

  loadItems();
}

// 削除処理
async function deleteItem(id) {
  const pass = prompt("削除パスワードを入力してね");

  if (pass !== "pass") {
    alert("パスワードが違うよ");
    return;
  }

  await client.from("items").delete().eq("id", id);
  alert("削除しました");
  loadItems();
}

loadItems();
</script>
